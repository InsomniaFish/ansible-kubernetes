- name: Disable ufw (stop + disable)
  when: k8s_disable_ufw | bool
  block:
    - name: Stop ufw
      ansible.builtin.systemd:
        name: ufw
        state: stopped
      failed_when: false

    - name: Disable ufw
      ansible.builtin.systemd:
        name: ufw
        enabled: false
      failed_when: false

- name: Build k8s /etc/hosts entries from inventory (if not provided)
  when: k8s_hosts_entries | length == 0
  ansible.builtin.set_fact:
    k8s_hosts_entries: >-
      {%- set out = [] -%}
      {%- for h in (groups['k8s_cluster'] | default([])) -%}
      {%- set ip = (hostvars[h].ansible_host | default(h)) -%}
      {%- set _ = out.append({'ip': ip, 'name': h}) -%}
      {%- endfor -%}
      {{ out }}

- name: Ensure /etc/hosts has cluster entries
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE K8S CLUSTER HOSTS"
    block: |
      {% for e in k8s_hosts_entries %}
      {{ e.ip }} {{ e.name }}
      {% endfor %}

- name: Disable swap (fstab + swapoff)
  when: k8s_disable_swap | bool
  block:
    - name: Comment out swap entries in /etc/fstab
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^(?!#)(.*\s+swap\s+.*)$'
        replace: '#\1'
        backup: true

    - name: Swapoff -a
      when: not ansible_check_mode
      ansible.builtin.command: swapoff -a
      changed_when: false

- name: Install chrony
  ansible.builtin.apt:
    name: chrony
    state: present
    update_cache: true

- name: Configure chrony
  ansible.builtin.template:
    src: chrony.conf.j2
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: "0644"
    backup: true
  notify: restart chrony

- name: Enable chrony
  ansible.builtin.systemd:
    name: chrony
    enabled: true
    state: started

- name: Set timezone (optional)
  when: (k8s_timezone | default('')) | length > 0
  ansible.builtin.command: "timedatectl set-timezone {{ k8s_timezone }}"
  changed_when: false
  check_mode: false

- name: Apply limits.conf block
  ansible.builtin.blockinfile:
    path: /etc/security/limits.conf
    marker: "# {mark} ANSIBLE K8S LIMITS"
    block: "{{ limits_conf_block | trim }}"

- name: Install IPVS / networking tooling packages
  ansible.builtin.apt:
    name: "{{ ipvs_packages }}"
    state: present
    update_cache: true

- name: Persist kernel modules for K8s
  ansible.builtin.copy:
    dest: /etc/modules-load.d/k8s.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      # Managed by Ansible (role: k8s_init)
      {% for m in k8s_kernel_modules %}
      {{ m }}
      {% endfor %}
  notify: restart systemd-modules-load

- name: Load kernel modules now
  when: not ansible_check_mode
  ansible.builtin.command: "modprobe {{ item }}"
  loop: "{{ k8s_kernel_modules }}"
  register: modprobe_results
  changed_when: false
  failed_when: false

- name: Configure sysctl for Kubernetes
  ansible.builtin.template:
    src: sysctl-k8s.conf.j2
    dest: /etc/sysctl.d/k8s.conf
    owner: root
    group: root
    mode: "0644"
  notify: apply sysctl


