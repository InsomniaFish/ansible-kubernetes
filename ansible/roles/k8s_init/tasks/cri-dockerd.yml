- name: Check distro-specific cri-dockerd deb exists on controller
  ansible.builtin.stat:
    path: "{{ cri_dockerd_local_deb_src }}"
  delegate_to: localhost
  register: cri_dockerd_local_deb_stat_v
  check_mode: false

- name: Check generic cri-dockerd deb exists on controller (backward compatible)
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/files/cri-dockerd.deb"
  delegate_to: localhost
  register: cri_dockerd_local_deb_stat_generic
  check_mode: false

- name: Select cri-dockerd deb artifact
  ansible.builtin.set_fact:
    cri_dockerd_effective_deb_src: >-
      {{
        (cri_dockerd_local_deb_src if cri_dockerd_local_deb_stat_v.stat.exists else
        (playbook_dir ~ '/files/cri-dockerd.deb' if cri_dockerd_local_deb_stat_generic.stat.exists else ''))
      }}
  check_mode: false

- name: Fail if local cri-dockerd deb is missing
  ansible.builtin.fail:
    msg: >-
      Missing local cri-dockerd deb.
      Provide either:
      - {{ cri_dockerd_local_deb_src }} (recommended for {{ ansible_distribution_release }})
      - {{ playbook_dir }}/files/cri-dockerd.deb (generic fallback)
  when: (cri_dockerd_effective_deb_src | default('') | trim) == ""

- name: Copy cri-dockerd deb to node
  ansible.builtin.copy:
    src: "{{ cri_dockerd_effective_deb_src }}"
    dest: "{{ cri_dockerd_local_deb_dest }}"
    owner: root
    group: root
    mode: "0644"
  check_mode: false

- name: Install cri-dockerd deb (with dependency fix-up if needed)
  block:
    - name: Install deb via apt
      ansible.builtin.apt:
        deb: "{{ cri_dockerd_local_deb_dest }}"
        state: present
        update_cache: true
  rescue:
    - name: Fix missing dependencies
      when: not ansible_check_mode
      ansible.builtin.command: apt-get -f -y install
      changed_when: false

    - name: Re-try installing deb via apt
      ansible.builtin.apt:
        deb: "{{ cri_dockerd_local_deb_dest }}"
        state: present

- name: Enable and start cri-docker service
  ansible.builtin.systemd:
    name: cri-docker
    enabled: true
    state: started

- name: Ensure systemd drop-in directory exists for cri-docker
  ansible.builtin.file:
    path: /etc/systemd/system/cri-docker.service.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Configure cri-docker ExecStart override (pause image mirror)
  ansible.builtin.copy:
    dest: /etc/systemd/system/cri-docker.service.d/override.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      [Service]
      ExecStart=
      ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --pod-infra-container-image {{ cri_dockerd_pause_image }}
  notify:
    - reload systemd
    - restart cri-docker


